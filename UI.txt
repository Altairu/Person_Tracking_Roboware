<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ロボットコントローラー</title>
    <style>
        /* 十字キーエリアのスタイル */
        .dpad-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 300px;
            width: 300px;
            margin: 0 auto;
        }

        .dpad-row {
            display: flex;
        }

        .dpad-button {
            width: 80px;
            height: 80px;
            margin: 5px;
            background-color: #e0e0e0;
            border: 2px solid #333;
            border-radius: 10px;
            text-align: center;
            line-height: 80px;
            font-size: 18px;
            user-select: none; /* テキスト選択を無効化 */
        }

        .dpad-button:active {
            background-color: #00a2ff;
        }
    </style>
</head>
<body>

    <h1>ロボットコントローラー</h1>

    <!-- 十字キー部分 -->
    <div class="dpad-container">
        <div class="dpad-row">
            <div class="dpad-button" id="up-button">前</div>
        </div>
        <div class="dpad-row">
            <div class="dpad-button" id="left-button">左</div>
            <div class="dpad-button">•</div> <!-- 中央の固定ボタン -->
            <div class="dpad-button" id="right-button">右</div>
        </div>
        <div class="dpad-row">
            <div class="dpad-button" id="down-button">後</div>
        </div>
    </div>

    <script>
        let omega = 0;  // オメガの値
        let v = 0;      // Vの値（mm/s）
        let isSending = false;  // データ送信中かどうかのフラグ
        let sendInterval;       // データ送信の間隔タイマー

        // WebSocket接続の設定
        const ws = new WebSocket('ws://192.168.137.216:8080/ws');  // サーバーのIPとポート

        ws.onopen = function() {
            console.log('WebSocket connection opened');
        };

        ws.onmessage = function(event) {
            console.log('Message from server: ', event.data);
        };

        ws.onerror = function(error) {
            console.error('WebSocket Error: ', error);
        };

        ws.onclose = function() {
            console.log('WebSocket connection closed');
        };

        // データ送信関数
        function sendDataToWebSocket() {
            if (ws.readyState === WebSocket.OPEN) {
                const data = `${v},${omega}`;  // mm/s単位の速度
                ws.send(data);
                console.log(`Sent data: V=${v}mm/s, Omega=${omega}`);
            } else {
                console.warn('WebSocket is not open. Cannot send data.');
            }
        }

        // データを連続的に送信するための関数
        function startSendingData() {
            if (!isSending) {
                isSending = true;
                sendInterval = setInterval(sendDataToWebSocket, 100);  // 100ミリ秒ごとにデータを送信
            }
        }

        // データ送信を停止し、V=0, ω=0を送り続ける
        function stopSendingData() {
            clearInterval(sendInterval);
            isSending = false;
            v = 0;
            omega = 0;
            sendDataToWebSocket();  // 停止時もすぐにデータを送信
            startSendingData();     // V=0, ω=0を送り続ける
        }

        // 十字キーのクリックイベントを設定
        document.getElementById('up-button').addEventListener('mousedown', () => {
            v = 100;    // 前進する速度
            omega = 0;  // 回転なし
            startSendingData();
        });

        document.getElementById('down-button').addEventListener('mousedown', () => {
            v = -100;   // 後退する速度
            omega = 0;  // 回転なし
            startSendingData();
        });

        document.getElementById('left-button').addEventListener('mousedown', () => {
            v = 0;      // 速度なし
            omega = -5; // 左回転
            startSendingData();
        });

        document.getElementById('right-button').addEventListener('mousedown', () => {
            v = 0;      // 速度なし
            omega = 5;  // 右回転
            startSendingData();
        });

        // ボタンが離されたときのイベント設定
        document.getElementById('up-button').addEventListener('mouseup', stopSendingData);
        document.getElementById('down-button').addEventListener('mouseup', stopSendingData);
        document.getElementById('left-button').addEventListener('mouseup', stopSendingData);
        document.getElementById('right-button').addEventListener('mouseup', stopSendingData);

        // タッチデバイス対応のためのイベント設定
        document.getElementById('up-button').addEventListener('touchstart', (e) => { e.preventDefault(); v = 100; omega = 0; startSendingData(); });
        document.getElementById('down-button').addEventListener('touchstart', (e) => { e.preventDefault(); v = -100; omega = 0; startSendingData(); });
        document.getElementById('left-button').addEventListener('touchstart', (e) => { e.preventDefault(); v = 0; omega = -5; startSendingData(); });
        document.getElementById('right-button').addEventListener('touchstart', (e) => { e.preventDefault(); v = 0; omega = 5; startSendingData(); });

        document.getElementById('up-button').addEventListener('touchend', stopSendingData);
        document.getElementById('down-button').addEventListener('touchend', stopSendingData);
        document.getElementById('left-button').addEventListener('touchend', stopSendingData);
        document.getElementById('right-button').addEventListener('touchend', stopSendingData);
    </script>

</body>
</html>
